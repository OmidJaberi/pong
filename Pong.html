<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Pong Game</title>
	<style type="text/css">
		* {
			padding: 0;
			margin: 0;
		}
		body {
			overflow: hidden;
		}
		.panel {
			position: fixed;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: space-evenly;
			background: white;
			width: 100vw;
			height: 100vh;
			z-index: 1000;
		}
		.controller {
			z-index: 990;
		}
		button {
			width: 25vw;
			height: 8vw;
			border: 0.5vw solid black;
			background: white;
			font-family: "arial";
			font-size: 2vw;
			font-weight: bold;
		}
		button:hover {
			background: black;
			color: white;
		}
		.scores {
			display: flex;
			flex-direction: row;
			justify-content: space-around;
			font-family: "arial";
			font-size: 10vw;
		}
		canvas {
			position: fixed;
			cursor: none;
			top: 0;
			left: 0;
		}
		.paused {
			position: fixed;
			bottom: 1vw;
			left: 1vw;
			font-family: "arial";
			font-size: 2vw;
			font-weight: bold;
		}
	</style>
</head>
<body>
	<div class="panel" id="panel">
		<button onclick="run(0)">Auto Play!</button>
		<button onclick="run(1)">One Player</button>
		<button onclick="run(2)">Two Players</button>
	</div>
	<div class="panel controller" id="panel2">
		<button onclick="setController('mouse')">Mouse</button>
		<button onclick="setController('keyboard')">Keyboard</button>
	</div>
	<div class="scores"><div id="left">0</div><div id="right">0</div></div>
	<canvas id="myCanvas"></canvas>
	<div class="paused" id="paused">Pong is paused, press space to continue...</div>
	<script>
	let left = document.getElementById('left');
	let right = document.getElementById('right');
	let canvas = document.getElementById("myCanvas");
	let ctx = canvas.getContext("2d");

	class Rocket {
		static arr = [];
		static width = 0.008;
		static height = 0.2;
		static speed = 0.007;
		static safeTime = 200;
		static AISpeed = 100; //Eeasy: 300 / Medium: 200 / Hard: 100
		constructor(p, ai = false) {
			this.p = p;
			this.x = (p == "l" ? 0.1 : 0.9) - (Rocket.width / 2);
			this.orientation = (p == "l" ? 1 : -1);
			this.y = 0.5 - (Rocket.height / 2);
			Rocket.arr.push(this);
			this.interval = null;
			this.safe = false;
			this.ai = ai;
			let play = setInterval(() => {
				if (!this.ai)
					return;
				this.stop();
				if ((this.p == 'l' && ball.dx > 0) || (this.p == 'r' && ball.dx < 0)) {
					if (0.47 > this.y + (Rocket.height / 2))
						this.move(+1);
					else if (0.53 < this.y + (Rocket.height / 2))
						this.move(-1);
					else
						this.stop();
				}
				else {
					if (ball.y > this.y + (1 * Rocket.height / 3) && ball.y < this.y + (2 * Rocket.height / 3))
						this.stop();
					else if (ball.y < this.y + (Rocket.height / 2))
						this.move(-1);
					else if (ball.y > this.y + (Rocket.height / 2))
						this.move(+1);
				}
			}, Rocket.AISpeed)
		}
		draw() {
			ctx.fillStyle = "#000000";
			ctx.fillRect(this.x * width, this.y * height, Rocket.width * width, Rocket.height * height);
		}
		move(dir) {
			if (this.interval || !play)
				return;
			this.interval = setInterval(() => {
				this.y += dir * Rocket.speed;
				if (this.y < 0)
					this.y = 0;
				if (this.y > 1 - Rocket.height)
					this.y = 1 - Rocket.height;
			}, 10)
		}
		stop() {
			clearInterval(this.interval);
			this.interval = null;
		}
		touch(x, y, r) {
			if (this.safe || ball.phased)
				return false;
			let dx = width * Math.max(this.x - x, 0, x - (this.x + Rocket.width));
			let dy = height * Math.max(this.y - y, 0, y - (this.y + Rocket.height));
			let t = Math.sqrt(dx * dx + dy * dy) < r;
			if (t) {
				this.safe = true;
				let x = setTimeout(() => {this.safe = false}, Rocket.safeTime);
			}
			return t;
		}
	}

	class Ball {
		static radius = 0.02;
		static speed = 0.020;
		static acceleration = 0.0004;
		constructor(x = 0.5, y = 0.4, dx = 1, dy = 0) {
			this.x = x;
			this.y = y;
			this.dx = dx;
			this.dy = dy;
			this.speed = Ball.speed;
			this.phased = false;
			this.interval = setInterval(() => {
				if (!play)
					return;
				this.x += this.dx * this.speed;
				this.y += this.dy * this.speed;
				if (this.x >= 1) {
					left.innerHTML ++;
					this.dx *= -1;
					this.spawn();
				}
				if (this.x <= 0) {
					right.innerHTML ++;
					this.dx *= -1;
					this.spawn();
				}
				if (this.y + Ball.radius >= 1 && this.dy > 0) {
					this.dy *= -1;
				}
				if (this.y - Ball.radius <= 0 && this.dy < 0) {
					this.dy *= -1;
				}
				for (let i = 0; i < Rocket.arr.length; i++) {
					if (Rocket.arr[i].touch(this.x, this.y, Ball.radius * height)) {
						this.speed += Ball.acceleration;
						let angle = (2 * Math.PI / 3) * (this.y - (Rocket.arr[i].y + (Rocket.height / 2))) / Rocket.height;
						console.log(angle / Math.PI, "PI");
						this.dy = Math.sin(angle);
						this.dx = Math.cos(angle) * Rocket.arr[i].orientation;
					}
				}
			}, 30);
		}
		draw() {
			ctx.beginPath();
			ctx.arc(this.x * width, this.y * height, Ball.radius * height, 0, 2 * Math.PI);
			ctx.fillStyle = "#000000";
			if (this.phased)
				ctx.fillStyle = "#FF0000";
			ctx.fill();
		}
		spawn() {
			this. x = 0.5;
			this.speed = Ball.speed;
		}
	}

	let width;
	let height;

	let rocket1 = new Rocket('l');
	let rocket2 = new Rocket('r');
	let ball = new Ball();
	let interval = null;
	let play = false;
	let control = 'keyboard';

	function midLine(n = 10) {
		let x = 2 * n + 1;
		ctx.fillStyle = "#000000";
		for (let i = 0; i < x; i++)
			if (i % 2 == 1)
				ctx.fillRect(0.497 * width, i * (height / x), 0.006 * width, height / x);
	}

	function draw() {
		ctx.clearRect(0, 0, width, height);
		midLine();
		rocket1.draw();
		rocket2.draw();
		ball.draw();
	}

	function resize() {
		let displayWidth = window.innerWidth;
		let displayHeight = window.innerHeight;
		let scale = 2;
		canvas.style.width = displayWidth + 'px';
		canvas.style.height = displayHeight + 'px';
		canvas.width = displayWidth * scale;
		canvas.height = displayHeight * scale;

		width = canvas.width;
		height = canvas.height;
		draw();
	}

	function pause() {
		if (document.getElementById('panel').style.display != 'none')
			return;
		play = !play;
		if (interval) {
			clearInterval(interval);
			interval = null;
			document.getElementById('paused').style.display = "block";
			canvas.style.cursor = "default";
		}
		else {
			interval = setInterval(draw, 30);
			document.getElementById('paused').style.display = "none";
			canvas.style.cursor = "none";
		}
	}

	function run(x) {
		if (x == 0) {
			rocket1.ai = true;
			rocket2.ai = true;
			document.getElementById('panel2').style.display = 'none';
		}
		else if (x == 1) {
			document.getElementById('panel').style.display = 'none';
			return;
		}
		else if (x == 2) {
			rocket1.ai = false;
			rocket2.ai = false;
			document.getElementById('panel2').style.display = 'none';
		}
		document.getElementById('panel').style.display = 'none';
		pause();
	}

	function setController(x) {
		control = x;
		document.getElementById('panel2').style.display = 'none';
		rocket1.ai = true;
		rocket2.ai = false;
		pause();
	}

	//--Event Handling--
	document.onkeydown = (event) => {
		if (event.key == ' ')
			pause();
		if (event.key == 'w')
			rocket1.move(-1);
		if (event.key == 's')
			rocket1.move(1);
		if (control == 'keyboard') {
			if (event.key == 'ArrowUp')
				rocket2.move(-1);
			if (event.key == 'ArrowDown')
				rocket2.move(1);
		}
	}
	
	document.onkeyup = (event) => {
		if (event.key == 'w' || event.key == 's')
			rocket1.stop();
		if (control == 'keyboard' && (event.key == 'ArrowUp' || event.key == 'ArrowDown'))
			rocket2.stop();
	}
	
	document.onmousemove = (event) => {
		if (control == 'mouse')
			rocket2.y = (2 * event.pageY / height) - Rocket.height / 2;
	}
	window.onresize = event => {resize()};
	resize();
	</script>
</body>
</html>